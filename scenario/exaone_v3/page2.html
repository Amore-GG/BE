<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GIGI - íƒ€ì„í…Œì´ë¸” ìƒì„±</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Noto Sans KR', sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
            padding: 40px 20px;
        }

        .header {
            max-width: 1400px;
            margin: 0 auto 40px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .logo {
            display: flex;
            align-items: baseline;
            gap: 10px;
        }

        .logo h1 {
            font-size: 2em;
            font-weight: 700;
            color: #2d3436;
            letter-spacing: -1px;
        }

        .logo span {
            font-size: 0.9em;
            color: #636e72;
            font-weight: 400;
        }

        .steps {
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .step {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #dfe6e9;
            color: #636e72;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 1.1em;
            position: relative;
        }

        .step.active {
            background: #2d3436;
            color: white;
        }

        .step.completed {
            background: #00b894;
            color: white;
        }

        .step::after {
            content: '';
            position: absolute;
            right: -20px;
            width: 20px;
            height: 2px;
            background: #dfe6e9;
        }

        .step:last-child::after {
            display: none;
        }

        .subtitle {
            text-align: center;
            color: #636e72;
            font-size: 1.1em;
            margin-bottom: 40px;
            font-weight: 400;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .card {
            background: white;
            border-radius: 16px;
            padding: 40px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
            margin-bottom: 30px;
        }

        .card-title {
            font-size: 1.4em;
            font-weight: 600;
            color: #2d3436;
            margin-bottom: 20px;
        }

        .scenario-display {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            line-height: 1.8;
            color: #2d3436;
            margin-bottom: 30px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 10px;
            color: #2d3436;
            font-size: 0.95em;
            font-weight: 500;
        }

        input[type="number"] {
            width: 200px;
            padding: 14px 16px;
            border: 1px solid #dfe6e9;
            border-radius: 8px;
            font-size: 1em;
            font-family: inherit;
        }

        input[type="number"]:focus {
            outline: none;
            border-color: #2d3436;
            box-shadow: 0 0 0 3px rgba(45, 52, 54, 0.1);
        }

        .button-group {
            display: flex;
            gap: 15px;
        }

        .btn {
            padding: 16px 32px;
            border: none;
            border-radius: 8px;
            font-size: 1.05em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: #2d3436;
            color: white;
        }

        .btn-primary:hover {
            background: #1e272e;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(45, 52, 54, 0.2);
        }

        .btn-secondary {
            background: #b2bec3;
            color: white;
        }

        .btn-secondary:hover {
            background: #636e72;
        }

        .btn:disabled {
            background: #b2bec3;
            cursor: not-allowed;
            transform: none;
        }

        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 20px;
            padding: 60px;
        }

        .loading.hidden {
            display: none;
        }

        .spinner {
            border: 3px solid #f1f3f5;
            border-top: 3px solid #2d3436;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            color: #636e72;
            font-size: 1em;
        }

        .timeline {
            margin-top: 30px;
        }

        .timeline-item {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            border-left: 4px solid #0984e3;
        }

        .timeline-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .timeline-time {
            background: #0984e3;
            color: white;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 600;
        }

        .scene-desc {
            color: #636e72;
            margin-bottom: 20px;
            line-height: 1.6;
        }

        .prompt-section {
            margin-top: 15px;
        }

        .prompt-title {
            font-size: 0.95em;
            font-weight: 600;
            color: #2d3436;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .prompt-badge {
            background: #00b894;
            color: white;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.75em;
            font-weight: 700;
        }

        .prompt-content {
            background: white;
            padding: 15px;
            border-radius: 8px;
            font-size: 0.9em;
            line-height: 1.6;
        }

        .prompt-field {
            margin-bottom: 10px;
        }

        .prompt-field-name {
            color: #636e72;
            font-size: 0.85em;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .prompt-field-value {
            color: #2d3436;
        }

        .dialogue-section {
            background: #fff3cd;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 4px solid #ffc107;
        }

        .dialogue-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .dialogue-title {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-regenerate {
            background: #f39c12;
            color: white;
            border: none;
            padding: 6px 14px;
            border-radius: 6px;
            font-size: 0.85em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-regenerate:hover {
            background: #e67e22;
            transform: translateY(-1px);
        }

        .btn-regenerate:disabled {
            background: #b2bec3;
            cursor: not-allowed;
            transform: none;
        }

        .dialogue-text {
            color: #856404;
            font-size: 1.05em;
            line-height: 1.6;
        }

        .dialogue-input {
            width: 100%;
            padding: 10px;
            border: 2px solid #ffc107;
            border-radius: 6px;
            font-size: 1.05em;
            line-height: 1.6;
            color: #856404;
            background: white;
            font-family: inherit;
            resize: vertical;
            min-height: 50px;
        }

        .dialogue-input:focus {
            outline: none;
            border-color: #f39c12;
            box-shadow: 0 0 0 3px rgba(243, 156, 18, 0.1);
        }

        .dialogue-actions {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }

        .btn-save {
            background: #00b894;
            color: white;
            border: none;
            padding: 6px 14px;
            border-radius: 6px;
            font-size: 0.85em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-save:hover {
            background: #00a085;
            transform: translateY(-1px);
        }

        .btn-cancel {
            background: #636e72;
            color: white;
            border: none;
            padding: 6px 14px;
            border-radius: 6px;
            font-size: 0.85em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-cancel:hover {
            background: #2d3436;
        }

        @media (max-width: 768px) {
            .button-group {
                flex-direction: column;
            }

            .btn {
                width: 100%;
            }

            .timeline-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="logo">
            <h1>GIGI</h1>
            <span>by AMOREPACIFIC</span>
        </div>
        <div class="steps">
            <div class="step completed">1</div>
            <div class="step active">2</div>
            <div class="step">3</div>
        </div>
    </div>

    <div class="subtitle">
        ì˜ìƒ ê¸¸ì´ë¥¼ ì…ë ¥í•˜ê³  íƒ€ì„í…Œì´ë¸”ì„ ìƒì„±í•˜ì„¸ìš”
    </div>

    <div class="container">
        <div class="card">
            <h2 class="card-title">ìƒì„±ëœ ì‹œë‚˜ë¦¬ì˜¤</h2>
            <div class="scenario-display" id="scenario-display">
                ì‹œë‚˜ë¦¬ì˜¤ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
            </div>

            <div class="form-group">
                <label class="form-label">ì˜ìƒ ê¸¸ì´ (ì´ˆ)</label>
                <input type="number" id="video-duration" value="25" min="5" max="300" step="5">
            </div>

            <div class="button-group">
                <button class="btn btn-secondary" onclick="goBack()">â† ì´ì „ìœ¼ë¡œ</button>
                <button class="btn btn-primary" id="generate-btn" onclick="generateTimetable()">
                    íƒ€ì„í…Œì´ë¸” ìƒì„±í•˜ê¸°
                </button>
            </div>
        </div>

        <div class="card" id="result-card" style="display: none;">
            <h2 class="card-title">íƒ€ì„í…Œì´ë¸” ê²°ê³¼</h2>

            <div class="loading hidden" id="loading">
                <div class="spinner"></div>
                <div class="loading-text">íƒ€ì„í…Œì´ë¸” ìƒì„± ì¤‘... (30ì´ˆ~1ë¶„ ì†Œìš”)</div>
            </div>

            <div id="timeline-content"></div>
        </div>
    </div>

    <script>
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹œë‚˜ë¦¬ì˜¤ ë¶ˆëŸ¬ì˜¤ê¸°
        window.onload = function() {
            const scenario = localStorage.getItem('scenario');
            const brand = localStorage.getItem('brand');

            if (!scenario) {
                alert('ì‹œë‚˜ë¦¬ì˜¤ê°€ ì—†ìŠµë‹ˆë‹¤. ì²« í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤.');
                window.location.href = '/';
                return;
            }

            document.getElementById('scenario-display').textContent = scenario;
        };

        // íƒ€ì„í…Œì´ë¸” ìƒì„± (ìŠ¤íŠ¸ë¦¬ë° ë°©ì‹)
        async function generateTimetable() {
            const scenario = localStorage.getItem('scenario');
            const brand = localStorage.getItem('brand') || '';
            const videoDuration = parseInt(document.getElementById('video-duration').value);

            if (!videoDuration || videoDuration < 5) {
                alert('ì˜ìƒ ê¸¸ì´ë¥¼ 5ì´ˆ ì´ìƒìœ¼ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            // UI ì—…ë°ì´íŠ¸
            const generateBtn = document.getElementById('generate-btn');
            const resultCard = document.getElementById('result-card');
            const loading = document.getElementById('loading');
            const timelineContent = document.getElementById('timeline-content');

            generateBtn.disabled = true;
            resultCard.style.display = 'block';
            loading.classList.remove('hidden');
            timelineContent.innerHTML = '';

            // ìŠ¤íŠ¸ë¦¬ë° ë°ì´í„° ì €ì¥
            let streamData = {
                total_duration: videoDuration,
                scene_count: 0,
                timetable: [],
                image_paths: []
            };

            try {
                const response = await fetch('http://localhost:8000/generate-timetable-stream', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        scenario: scenario,
                        video_duration: videoDuration,
                        brand: brand
                    })
                });

                if (!response.ok) {
                    throw new Error('íƒ€ì„í…Œì´ë¸” ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';

                while (true) {
                    const { done, value } = await reader.read();

                    if (done) break;

                    buffer += decoder.decode(value, { stream: true });
                    const lines = buffer.split('\n\n');

                    // ë§ˆì§€ë§‰ ë¶ˆì™„ì „í•œ ì¤„ì€ ë²„í¼ì— ë³´ê´€
                    buffer = lines.pop() || '';

                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            const eventData = JSON.parse(line.slice(6));

                            if (eventData.type === 'metadata') {
                                // ë©”íƒ€ë°ì´í„° ìˆ˜ì‹ 
                                streamData.scene_count = eventData.data.scene_count;
                                loading.querySelector('.loading-text').textContent =
                                    `íƒ€ì„í…Œì´ë¸” ìƒì„± ì¤‘... (ì´ ${eventData.data.scene_count}ê°œ ì¥ë©´)`;

                            } else if (eventData.type === 'scene') {
                                // ì¥ë©´ ë°ì´í„° ìˆ˜ì‹  - ì¦‰ì‹œ í™”ë©´ì— ì¶”ê°€
                                const sceneData = eventData.data;
                                streamData.timetable.push(sceneData);
                                timetableData.push(sceneData);  // ì „ì—­ ë³€ìˆ˜ì— ì €ì¥

                                // ì‹¤ì‹œê°„ìœ¼ë¡œ ì¥ë©´ í‘œì‹œ
                                appendScene(sceneData, sceneData.index);

                                // ì§„í–‰ìƒí™© ì—…ë°ì´íŠ¸
                                loading.querySelector('.loading-text').textContent =
                                    `íƒ€ì„í…Œì´ë¸” ìƒì„± ì¤‘... (${sceneData.index + 1}/${streamData.scene_count})`;

                            } else if (eventData.type === 'complete') {
                                // ì™„ë£Œ
                                console.log('íƒ€ì„í…Œì´ë¸” ìƒì„± ì™„ë£Œ!');

                            } else if (eventData.type === 'error') {
                                throw new Error(eventData.data.message);
                            }
                        }
                    }
                }

            } catch (error) {
                console.error('ì—ëŸ¬:', error);
                timelineContent.innerHTML = `<div style="color: #ff6b6b; padding: 20px;">${error.message}</div>`;
            } finally {
                generateBtn.disabled = false;
                loading.classList.add('hidden');
            }
        }

        // ì¥ë©´ì„ í•˜ë‚˜ì”© ì¶”ê°€í•˜ëŠ” í•¨ìˆ˜
        function appendScene(item, index) {
            const timelineContent = document.getElementById('timeline-content');

            // ì²« ë²ˆì§¸ ì¥ë©´ì´ë©´ í—¤ë” ì¶”ê°€
            if (index === 0) {
                const headerHtml = `<div style="margin-bottom: 20px; color: #636e72; font-weight: 600;">
                    ì¥ë©´ì„ ìƒì„±í•˜ëŠ” ì¤‘...
                </div>`;
                timelineContent.innerHTML = headerHtml;
            }

            const sceneHtml = `
                <div class="timeline-item" id="scene-${index}">
                    <div class="timeline-header">
                        <h3 style="color: #2d3436; font-size: 1.1em;">ì¥ë©´ ${index + 1}</h3>
                        <div class="timeline-time">${item.time_start}s - ${item.time_end}s</div>
                    </div>

                    <div class="scene-desc">${item.scene_description}</div>

                    <div class="dialogue-section">
                        <div class="dialogue-header">
                            <div class="dialogue-title">
                                <span style="font-size: 1.2em;">ğŸ’¬</span>
                                <strong style="color: #856404;">ì§€ì§€ì˜ ë°œí™”</strong>
                            </div>
                            <div style="display: flex; gap: 8px;">
                                <button class="btn-regenerate" onclick="regenerateDialogue(${index})">
                                    ğŸ”„ ì¬ìƒì„±
                                </button>
                                <button class="btn-regenerate" onclick="enableEditDialogue(${index})" id="edit-btn-${index}">
                                    âœï¸ ìˆ˜ì •
                                </button>
                            </div>
                        </div>
                        <div class="dialogue-text" id="dialogue-display-${index}" onclick="enableEditDialogue(${index})" style="cursor: pointer;">
                            "${item.dialogue || '(ë°œí™” ì—†ìŒ)'}"
                        </div>
                        <div id="dialogue-edit-${index}" style="display: none;">
                            <textarea class="dialogue-input" id="dialogue-input-${index}">${item.dialogue || ''}</textarea>
                            <div class="dialogue-actions">
                                <button class="btn-save" onclick="saveDialogue(${index})">ğŸ’¾ ì €ì¥</button>
                                <button class="btn-cancel" onclick="cancelEditDialogue(${index})">ì·¨ì†Œ</button>
                            </div>
                        </div>
                        ${item.narration ? `
                            <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #ffeaa7;">
                                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 5px;">
                                    <span style="font-size: 1.1em;">ğŸ™ï¸</span>
                                    <strong style="color: #856404; font-size: 0.9em;">ë‚˜ë ˆì´ì…˜</strong>
                                </div>
                                <div style="color: #856404; font-size: 0.95em; font-style: italic;">
                                    ${item.narration}
                                </div>
                            </div>
                        ` : ''}
                    </div>

                    <div class="prompt-section">
                        <div class="prompt-title">
                            <span class="prompt-badge">T2I</span>
                            Text-to-Image Prompt
                        </div>
                        <div class="prompt-content">
                            <div class="prompt-field">
                                <div class="prompt-field-name">Background:</div>
                                <div class="prompt-field-value">${item.t2i_prompt.background}</div>
                            </div>
                            <div class="prompt-field">
                                <div class="prompt-field-name">Character Pose & Gaze:</div>
                                <div class="prompt-field-value">${item.t2i_prompt.character_pose_and_gaze}</div>
                            </div>
                            <div class="prompt-field">
                                <div class="prompt-field-name">Product:</div>
                                <div class="prompt-field-value">${item.t2i_prompt.product}</div>
                            </div>
                            <div class="prompt-field">
                                <div class="prompt-field-name">Camera Angle:</div>
                                <div class="prompt-field-value">${item.t2i_prompt.camera_angle}</div>
                            </div>
                        </div>
                    </div>

                    <div class="prompt-section" style="margin-top: 15px;">
                        <div class="prompt-title">
                            <span class="prompt-badge" style="background: #fd79a8;">Edit</span>
                            Image Edit Prompt
                        </div>
                        <div class="prompt-content">
                            <div class="prompt-field">
                                <div class="prompt-field-name">Pose Change:</div>
                                <div class="prompt-field-value">${item.image_edit_prompt.pose_change}</div>
                            </div>
                            <div class="prompt-field">
                                <div class="prompt-field-name">Gaze Change:</div>
                                <div class="prompt-field-value">${item.image_edit_prompt.gaze_change}</div>
                            </div>
                            <div class="prompt-field">
                                <div class="prompt-field-name">Expression:</div>
                                <div class="prompt-field-value">${item.image_edit_prompt.expression}</div>
                            </div>
                            <div class="prompt-field">
                                <div class="prompt-field-name">Additional Edits:</div>
                                <div class="prompt-field-value">${item.image_edit_prompt.additional_edits}</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            timelineContent.insertAdjacentHTML('beforeend', sceneHtml);

            // ìŠ¤í¬ë¡¤ì„ ìƒˆë¡œ ì¶”ê°€ëœ ì¥ë©´ìœ¼ë¡œ ì´ë™
            const newScene = document.getElementById(`scene-${index}`);
            if (newScene) {
                newScene.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }
        }

        // íƒ€ì„í…Œì´ë¸” í‘œì‹œ
        function displayTimetable(data) {
            const timelineContent = document.getElementById('timeline-content');

            let html = `<div style="margin-bottom: 20px; color: #636e72;">
                ì´ ${data.scene_count}ê°œ ì¥ë©´ / ${data.total_duration}ì´ˆ
            </div>`;

            data.timetable.forEach((item, index) => {
                html += `
                    <div class="timeline-item">
                        <div class="timeline-header">
                            <h3 style="color: #2d3436; font-size: 1.1em;">ì¥ë©´ ${index + 1}</h3>
                            <div class="timeline-time">${item.time_start}s - ${item.time_end}s</div>
                        </div>

                        <div class="scene-desc">${item.scene_description}</div>

                        <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin: 15px 0; border-left: 4px solid #ffc107;">
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                <span style="font-size: 1.2em;">ğŸ’¬</span>
                                <strong style="color: #856404;">ì§€ì§€ì˜ ë°œí™”</strong>
                            </div>
                            <div style="color: #856404; font-size: 1.05em; line-height: 1.6;">
                                "${item.dialogue || '(ë°œí™” ì—†ìŒ)'}"
                            </div>
                            ${item.narration ? `
                                <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #ffeaa7;">
                                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 5px;">
                                        <span style="font-size: 1.1em;">ğŸ™ï¸</span>
                                        <strong style="color: #856404; font-size: 0.9em;">ë‚˜ë ˆì´ì…˜</strong>
                                    </div>
                                    <div style="color: #856404; font-size: 0.95em; font-style: italic;">
                                        ${item.narration}
                                    </div>
                                </div>
                            ` : ''}
                        </div>

                        ${data.image_paths && data.image_paths[index] ? `
                            <div style="margin: 20px 0;">
                                <img src="/${data.image_paths[index]}"
                                     alt="Scene ${index + 1}"
                                     style="width: 100%; max-width: 600px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                            </div>
                        ` : ''}

                        <div class="prompt-section">
                            <div class="prompt-title">
                                <span class="prompt-badge">T2I</span>
                                Text-to-Image Prompt
                            </div>
                            <div class="prompt-content">
                                <div class="prompt-field">
                                    <div class="prompt-field-name">Background:</div>
                                    <div class="prompt-field-value">${item.t2i_prompt.background}</div>
                                </div>
                                <div class="prompt-field">
                                    <div class="prompt-field-name">Character Pose & Gaze:</div>
                                    <div class="prompt-field-value">${item.t2i_prompt.character_pose_and_gaze}</div>
                                </div>
                                <div class="prompt-field">
                                    <div class="prompt-field-name">Product:</div>
                                    <div class="prompt-field-value">${item.t2i_prompt.product}</div>
                                </div>
                                <div class="prompt-field">
                                    <div class="prompt-field-name">Camera Angle:</div>
                                    <div class="prompt-field-value">${item.t2i_prompt.camera_angle}</div>
                                </div>
                            </div>
                        </div>

                        <div class="prompt-section" style="margin-top: 15px;">
                            <div class="prompt-title">
                                <span class="prompt-badge" style="background: #fd79a8;">Edit</span>
                                Image Edit Prompt
                            </div>
                            <div class="prompt-content">
                                <div class="prompt-field">
                                    <div class="prompt-field-name">Pose Change:</div>
                                    <div class="prompt-field-value">${item.image_edit_prompt.pose_change}</div>
                                </div>
                                <div class="prompt-field">
                                    <div class="prompt-field-name">Gaze Change:</div>
                                    <div class="prompt-field-value">${item.image_edit_prompt.gaze_change}</div>
                                </div>
                                <div class="prompt-field">
                                    <div class="prompt-field-name">Expression:</div>
                                    <div class="prompt-field-value">${item.image_edit_prompt.expression}</div>
                                </div>
                                <div class="prompt-field">
                                    <div class="prompt-field-name">Additional Edits:</div>
                                    <div class="prompt-field-value">${item.image_edit_prompt.additional_edits}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });

            timelineContent.innerHTML = html;
        }

        // ì „ì—­ ë³€ìˆ˜ë¡œ íƒ€ì„í…Œì´ë¸” ë°ì´í„° ì €ì¥
        let timetableData = [];

        // ë°œí™” ìˆ˜ì • ëª¨ë“œ í™œì„±í™”
        function enableEditDialogue(sceneIndex) {
            const displayElement = document.getElementById(`dialogue-display-${sceneIndex}`);
            const editElement = document.getElementById(`dialogue-edit-${sceneIndex}`);
            const editBtn = document.getElementById(`edit-btn-${sceneIndex}`);

            displayElement.style.display = 'none';
            editElement.style.display = 'block';
            editBtn.style.display = 'none';

            // textareaì— í¬ì»¤ìŠ¤
            const textarea = document.getElementById(`dialogue-input-${sceneIndex}`);
            textarea.focus();
            textarea.select();
        }

        // ë°œí™” ìˆ˜ì • ì·¨ì†Œ
        function cancelEditDialogue(sceneIndex) {
            const displayElement = document.getElementById(`dialogue-display-${sceneIndex}`);
            const editElement = document.getElementById(`dialogue-edit-${sceneIndex}`);
            const editBtn = document.getElementById(`edit-btn-${sceneIndex}`);
            const inputElement = document.getElementById(`dialogue-input-${sceneIndex}`);

            // ì›ë˜ ê°’ìœ¼ë¡œ ë³µì›
            inputElement.value = timetableData[sceneIndex].dialogue || '';

            displayElement.style.display = 'block';
            editElement.style.display = 'none';
            editBtn.style.display = 'block';
        }

        // ë°œí™” ì €ì¥
        function saveDialogue(sceneIndex) {
            const inputElement = document.getElementById(`dialogue-input-${sceneIndex}`);
            const displayElement = document.getElementById(`dialogue-display-${sceneIndex}`);
            const editElement = document.getElementById(`dialogue-edit-${sceneIndex}`);
            const editBtn = document.getElementById(`edit-btn-${sceneIndex}`);

            const newDialogue = inputElement.value.trim();

            // í™”ë©´ ì—…ë°ì´íŠ¸
            displayElement.textContent = newDialogue ? `"${newDialogue}"` : '(ë°œí™” ì—†ìŒ)';

            // ë°ì´í„° ì—…ë°ì´íŠ¸
            timetableData[sceneIndex].dialogue = newDialogue;

            // í¸ì§‘ ëª¨ë“œ ì¢…ë£Œ
            displayElement.style.display = 'block';
            editElement.style.display = 'none';
            editBtn.style.display = 'block';

            // ì €ì¥ í”¼ë“œë°±
            const saveBtn = event.target;
            const originalText = saveBtn.textContent;
            saveBtn.textContent = 'âœ“ ì €ì¥ë¨';
            saveBtn.style.background = '#00b894';

            setTimeout(() => {
                saveBtn.textContent = originalText;
                saveBtn.style.background = '';
            }, 1500);
        }

        // ë°œí™” ì¬ìƒì„±
        async function regenerateDialogue(sceneIndex) {
            const button = event.target;
            const dialogueDisplay = document.getElementById(`dialogue-display-${sceneIndex}`);
            const dialogueInput = document.getElementById(`dialogue-input-${sceneIndex}`);

            if (!timetableData[sceneIndex]) {
                alert('ì¥ë©´ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            // ë²„íŠ¼ ë¹„í™œì„±í™”
            button.disabled = true;
            button.textContent = 'ğŸ”„ ìƒì„± ì¤‘...';
            dialogueDisplay.textContent = 'ë°œí™”ë¥¼ ìƒì„±í•˜ëŠ” ì¤‘...';

            try {
                // ì´ì „ ì¥ë©´ë“¤ì˜ ë°œí™” ìˆ˜ì§‘
                const previousDialogues = timetableData
                    .slice(0, sceneIndex)
                    .map(scene => scene.dialogue)
                    .filter(d => d && d.trim());

                const response = await fetch('http://localhost:8000/regenerate-dialogue', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        scene_description: timetableData[sceneIndex].scene_description,
                        previous_dialogues: previousDialogues
                    })
                });

                if (!response.ok) {
                    throw new Error('ë°œí™” ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }

                const data = await response.json();
                const newDialogue = data.dialogue || '';

                // í™”ë©´ ì—…ë°ì´íŠ¸ (displayì™€ input ë‘˜ ë‹¤)
                dialogueDisplay.textContent = newDialogue ? `"${newDialogue}"` : '(ë°œí™” ì—†ìŒ)';
                dialogueInput.value = newDialogue;

                // ë°ì´í„° ì—…ë°ì´íŠ¸
                timetableData[sceneIndex].dialogue = newDialogue;

                // ì„±ê³µ ë©”ì‹œì§€
                button.style.background = '#00b894';
                button.textContent = 'âœ“ ì™„ë£Œ';

                setTimeout(() => {
                    button.style.background = '#f39c12';
                    button.textContent = 'ğŸ”„ ì¬ìƒì„±';
                    button.disabled = false;
                }, 2000);

            } catch (error) {
                console.error('ì—ëŸ¬:', error);
                dialogueDisplay.textContent = 'ë°œí™” ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
                button.textContent = 'ğŸ”„ ì¬ìƒì„±';
                button.disabled = false;
                alert(error.message);
            }
        }

        // ì´ì „ í˜ì´ì§€ë¡œ
        function goBack() {
            window.location.href = '/';
        }
    </script>
</body>
</html>
